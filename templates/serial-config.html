<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serial Port Configuration - Medical Robot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <style>
        .port-config-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .port-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .port-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .port-item:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .port-item.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .port-info {
            flex: 1;
        }
        
        .port-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        
        .port-description {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .status-connected {
            background: #28a745;
        }
        
        .status-disconnected {
            background: #dc3545;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-text {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .sensor-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .sensor-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }
        
        .sensor-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .sensor-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .sensor-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .sensor-source {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }
        
        .sensor-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .sensor-status .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-no-data {
            background: #dc3545;
        }
        
        .status-receiving {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="port-config-container">
        <h1>üîå Serial Port Configuration</h1>
        <p>Select the COM port where your ESP32 is connected to start receiving sensor data.</p>
        
        <div class="port-card">
            <h3>Available COM Ports</h3>
            <button class="btn btn-primary" onclick="refreshPorts()">üîÑ Refresh Ports</button>
            
            <div id="ports-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Scanning for available ports...</p>
                </div>
            </div>
            
            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div>
        </div>
        
        <div class="port-card">
            <h3>Connection Control</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-success" id="start-btn" onclick="startSerialReader()" disabled>
                    ‚ñ∂Ô∏è Start Serial Reader
                </button>
                <button class="btn btn-danger" id="stop-btn" onclick="stopSerialReader()" disabled>
                    ‚èπÔ∏è Stop Serial Reader
                </button>
            </div>
            
            <div class="status-section">
                <div class="status-text">Status: <span id="connection-status">Disconnected</span></div>
                <div id="selected-port-info" style="display: none;">
                    <strong>Selected Port:</strong> <span id="selected-port-name"></span>
                </div>
            </div>
        </div>
        
        <div class="port-card">
            <h3>üìä Live Sensor Data</h3>
            <p>Real-time sensor readings from your ESP32:</p>
            
            <div class="sensor-grid">
                <div class="sensor-card">
                    <div class="sensor-icon">üå°Ô∏è</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Body Temperature</div>
                        <div class="sensor-value" id="body-temp">--¬∞C</div>
                        <div class="sensor-source">MLX90614</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">üå°Ô∏è</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Room Temperature</div>
                        <div class="sensor-value" id="room-temp">--¬∞C</div>
                        <div class="sensor-source">DHT22</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">üíß</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Humidity</div>
                        <div class="sensor-value" id="humidity">--%</div>
                        <div class="sensor-source">DHT22</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">‚ù§Ô∏è</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Heart Rate</div>
                        <div class="sensor-value" id="heart-rate">-- BPM</div>
                        <div class="sensor-source">MAX30102</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">ü´Å</div>
                    <div class="sensor-info">
                        <div class="sensor-label">SpO2</div>
                        <div class="sensor-value" id="spo2">--%</div>
                        <div class="sensor-source">MAX30102</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">üìè</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Distance</div>
                        <div class="sensor-value" id="distance">-- cm</div>
                        <div class="sensor-source">HC-SR04</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">‚öñÔ∏è</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Weight</div>
                        <div class="sensor-value" id="weight">-- g</div>
                        <div class="sensor-source">HX711</div>
                    </div>
                </div>
                
                <div class="sensor-card">
                    <div class="sensor-icon">üïí</div>
                    <div class="sensor-info">
                        <div class="sensor-label">Last Update</div>
                        <div class="sensor-value" id="last-update">Never</div>
                        <div class="sensor-source">Timestamp</div>
                    </div>
                </div>
            </div>
            
            <div class="sensor-status">
                <div class="status-indicator" id="data-status-indicator"></div>
                <span id="data-status-text">No data received</span>
            </div>
        </div>
        
        <div class="port-card">
            <h3>üìã Instructions</h3>
            <ol>
                <li>Connect your ESP32 to your computer via USB cable</li>
                <li>Click "Refresh Ports" to scan for available COM ports</li>
                <li>Select the port where your ESP32 is connected (usually COM3, COM4, etc.)</li>
                <li>Click "Start Serial Reader" to begin receiving sensor data</li>
                <li>Watch the sensor values update in real-time above</li>
                <li>Go to the <a href="/dashboard">Dashboard</a> to view patient data</li>
            </ol>
            
            <h4>üîß Troubleshooting</h4>
            <ul>
                <li>Make sure ESP32 is properly connected via USB</li>
                <li>Check Device Manager (Windows) to see available COM ports</li>
                <li>Ensure no other program is using the selected port</li>
                <li>Try different USB cables or ports if connection fails</li>
                <li>If no sensor data appears, check ESP32 serial monitor for errors</li>
            </ul>
        </div>
    </div>

    <script>
        let selectedPort = null;
        let isConnected = false;

        // Load available ports on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshPorts();
            startSensorDataPolling();
        });

        async function refreshPorts() {
            const portsList = document.getElementById('ports-list');
            const loading = portsList.querySelector('.loading');
            const errorMessage = document.getElementById('error-message');
            
            // Show loading
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            
            try {
                const response = await fetch('/api/ports');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayPorts(data.ports);
                
            } catch (error) {
                showError('Failed to load ports: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayPorts(ports) {
            const portsList = document.getElementById('ports-list');
            
            if (ports.length === 0) {
                portsList.innerHTML = '<p style="text-align: center; color: #666;">No COM ports found. Make sure your ESP32 is connected.</p>';
                return;
            }
            
            portsList.innerHTML = ports.map(port => `
                <div class="port-item" onclick="selectPort('${port.device}', '${port.description}')">
                    <div class="port-info">
                        <div class="port-name">${port.device}</div>
                        <div class="port-description">${port.description}</div>
                    </div>
                    <div class="status-indicator status-disconnected"></div>
                </div>
            `).join('');
        }

        function selectPort(port, description) {
            // Remove previous selection
            document.querySelectorAll('.port-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            event.currentTarget.classList.add('selected');
            
            selectedPort = port;
            
            // Update UI
            document.getElementById('selected-port-name').textContent = `${port} - ${description}`;
            document.getElementById('selected-port-info').style.display = 'block';
            document.getElementById('start-btn').disabled = false;
            
            showSuccess(`Selected port: ${port}`);
        }

        async function startSerialReader() {
            if (!selectedPort) {
                showError('Please select a COM port first');
                return;
            }
            
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            startBtn.disabled = true;
            startBtn.textContent = 'üîÑ Starting...';
            
            try {
                const response = await fetch('/api/start-serial-reader', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ port: selectedPort })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                isConnected = true;
                updateConnectionStatus('Connected', 'success');
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                showSuccess(`Serial reader started on ${selectedPort}`);
                
            } catch (error) {
                showError('Failed to start serial reader: ' + error.message);
                startBtn.disabled = false;
                startBtn.textContent = '‚ñ∂Ô∏è Start Serial Reader';
            }
        }

        async function stopSerialReader() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            stopBtn.disabled = true;
            stopBtn.textContent = 'üîÑ Stopping...';
            
            try {
                const response = await fetch('/api/stop-serial-reader', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                isConnected = false;
                updateConnectionStatus('Disconnected', 'danger');
                startBtn.disabled = false;
                stopBtn.disabled = true;
                stopBtn.textContent = '‚èπÔ∏è Stop Serial Reader';
                
                showSuccess('Serial reader stopped');
                
            } catch (error) {
                showError('Failed to stop serial reader: ' + error.message);
                stopBtn.disabled = false;
                stopBtn.textContent = '‚èπÔ∏è Stop Serial Reader';
            }
        }

        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = status;
            statusElement.className = `text-${type}`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Sensor data polling functions
        let sensorDataInterval = null;

        function startSensorDataPolling() {
            // Poll for sensor data every 2 seconds
            sensorDataInterval = setInterval(fetchSensorData, 2000);
        }

        function stopSensorDataPolling() {
            if (sensorDataInterval) {
                clearInterval(sensorDataInterval);
                sensorDataInterval = null;
            }
        }

        async function fetchSensorData() {
            try {
                const response = await fetch('/latest');
                const data = await response.json();
                
                if (data) {
                    updateSensorDisplay(data);
                    updateDataStatus(true);
                } else {
                    updateDataStatus(false);
                }
            } catch (error) {
                console.log('No sensor data available yet');
                updateDataStatus(false);
            }
        }

        function updateSensorDisplay(data) {
            // Update each sensor value
            document.getElementById('body-temp').textContent = 
                data.body_temperature ? data.body_temperature.toFixed(1) + '¬∞C' : '--¬∞C';
            
            document.getElementById('room-temp').textContent = 
                data.environment_temperature ? data.environment_temperature.toFixed(1) + '¬∞C' : '--¬∞C';
            
            document.getElementById('humidity').textContent = 
                data.humidity ? data.humidity.toFixed(1) + '%' : '--%';
            
            document.getElementById('heart-rate').textContent = 
                data.heart_rate ? data.heart_rate + ' BPM' : '-- BPM';
            
            document.getElementById('spo2').textContent = 
                data.spo2 ? data.spo2 + '%' : '--%';
            
            document.getElementById('distance').textContent = 
                data.distance ? data.distance.toFixed(1) + ' cm' : '-- cm';
            
            document.getElementById('weight').textContent = 
                data.weight ? data.weight.toFixed(1) + ' g' : '-- g';
            
            // Update last update time
            if (data.timestamp) {
                const lastUpdate = new Date(data.timestamp);
                document.getElementById('last-update').textContent = 
                    lastUpdate.toLocaleTimeString();
            }
        }

        function updateDataStatus(isReceiving) {
            const statusIndicator = document.getElementById('data-status-indicator');
            const statusText = document.getElementById('data-status-text');
            
            if (isReceiving) {
                statusIndicator.className = 'status-indicator status-receiving';
                statusText.textContent = 'Receiving data from ESP32';
            } else {
                statusIndicator.className = 'status-indicator status-no-data';
                statusText.textContent = 'No data received';
            }
        }
    </script>
</body>
</html>
